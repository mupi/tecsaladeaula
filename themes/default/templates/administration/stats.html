{% extends "base.html" %}
{% load compressed %}
{% load static %}
{% load i18n %}

{% block wrapper_classes %}
wrapper-course-lesson
{% endblock %}

{% block js %}
    {{ block.super }}
    {% compressed_js 'reports' %}
    <script>
        window.course_id = {{ course.pk }};
        window.user_id = {{ user.pk }};
        {% if user.is_staff or user.is_superuser  %}
        window.is_admin = true;
        {% else %}
        window.is_admin = false;
        {% endif %}
    </script>
{% endblock %}

{% block content %}
<div id="stats" class="course-stats" ng-app="reports">

    {% if in_admin %}
        {% include "_admin_header_inline.html" with course=course %}
    {% else %}
        {% include "_course-header-inline.html"  with course=course %}
    {% endif %}

    <section id="stats-content" class="container" ng-controller="ReportsCtrl">

        <header class="secondary-header main-header-users-by-course-report">
            <div class="row">
                <div class="col-sm-9">
                    <h1>{% trans "Course reports" %}</h1>
                </div>
            </div>
        </header>

        <!-- FILTERS ABRIL 2018 -->
        <div class="filters main-header-users-by-course-report">
            <!--  FORM INLINE -->
            <form class="form-horizontal">
                <!-- ROW -->
                <div class="row">
                        <div class="col-sm-6 col-xs-12">
                              <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12 without-paddings-rl">
                                <label class="control-label">{% trans "Filter classes" %}</label>
                              </div>
                              <div class="col-lg-8 col-md-8 col-sm-8 col-xs-12 padding-left-3px">
                                <select class="form-control" id="filter-class" ng-model="filters.selected_class">
                                    <optgroup label="Liste por:">
                                        <option ng-if="my_classes.length" value="my_classes">Minhas turmas</option>
                                        <option value="all" ng-if="current_user_role == 'coordinator'">Todas as turmas deste curso</option>
                                        <option value="others_classes" ng-if="current_user_role == 'coordinator' && others_classes.length">Turmas dos outros professores</option>
                                    </optgroup>
                                    <optgroup ng-if="others_classes.length || my_classes.length " label="Ou escolha uma turma:">
                                        {% verbatim %}
                                        <option ng-repeat="klass in my_classes" id="{{klass.id}}" value="{{klass.id}}">{{ klass.name }}</option>
                                        <option ng-repeat="klass in others_classes" id="{{klass.id}}" value="{{klass.id}}">{{ klass.name }}</option>
                                        {% endverbatim %}
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-6 col-xs-12">
                            <div class="col-lg-4 col-sm-4 col-xs-12 text-right">
                              <label class="control-label">{% trans "Student" %}</label>
                            </div>
                            <div class="col-lg-8 col-sm-8 col-xs-12 text-left without-paddings-rl">
                              <input type="text" placeholder="{% trans "E-mail or name" %}" class="form-control ng-pristine ng-valid" id="keyword" name="keyword" ng-model="filters.keyword">
                            </div>
                        </div>
                </div>

                <div class="row">
                <div class="col-sm-8">
                    <div class="col-lg-3 col-md-3 col-sm-3 col-xs-12 without-paddings-rl">
                      <label class="control-label">{% trans "Date joined"%}</label>
                    </div>
                    <div class="col-lg-9 col-md-9 col-sm-9 col-xs-12 without-paddings-rl">
                      <!-- Date range example -->
                          <div class="col-xs-6 without-paddings-rl">
                            <input type="text" class="form-control" ng-model="fromDate" data-max-date="{{untilDate}}" placeholder="de" bs-datepicker>
                          </div>
                          <div class="col-xs-6 without-paddings-rl">
                            <input type="text" class="form-control" ng-model="untilDate" data-min-date="{{fromDate}}" placeholder="até" bs-datepicker>
                          </div>
                    </div>

                </div>
                  <div class="col-sm-4">
                      <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 text-right">
                        <label class="control-label">% {% trans "Progress" %}</label>
                      </div>
                      <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 without-paddings-rl">
                        <select class="form-control" id="filter-class">
                                <option value="">0%</option>
                                <option value="">< 50%</option>
                                <option value="">>= 50%</option>
                                <option value="">>= 80%</option>
                        </select>
                      </div>
                  </div>
                </div>


                <div class="row">
                  <div class="col-sm-6">
                      <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12 without-paddings-rl">
                        <label class="control-label">Dias Inatividade</label>
                      </div>
                      <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 padding-left-3px">
                        <input type="number" class="form-control ng-pristine ng-valid">
                      </div>
                  </div>
                  <div class="col-sm-2 col-sx-12 without-paddings-rl">
                  </div>
                  <div class="col-sm-2 col-sx-12 without-paddings-rl">
                        <button class="btn btn-info" ng-click="filter_users()">Pesquisar</button>
                  </div>
                  <div class="col-sm-2 col-sx-12 without-paddings-rl">
                        <button class="btn btn-info" ng-click=""><i class="fa fa-download"></i> Exportar</button>
                      </div>
                  </div>
                <!-- END ROW -->
            </form>
            <!-- END FORM INLINE -->
        </div>
        <!-- END FILTERS -->

        <section class="row">
            <div class="col-xs-12">
                <ul class="nav nav-tabs">
                    <li class="active"><a href="#students" data-toggle="tab">{% trans "Students" %}</a></li>
                    <li><a href="#lessons" data-toggle="tab">{% trans "Lessons" %}</a></li>
                </ul>

                <!-- tab de ALUNOS -->
                <div class="tab-content">
                    <div class="tab-pane fade in active" id="students">
                        <div class="col-lg-12" ng-hide="users_reports.$resolved">
                            <p>{% trans 'Loading students report' %}...   <i class="loading fa fa-refresh fa-spin"></i></p>
                        </div>
                        <div class="row" ng-show="users_reports.$resolved">
                            <div class="col-sm-8  margin-b10">
                                <h3>{% trans 'Students progress' %}</h3>
                                <h4>{% trans 'Total number of students' %}: {% verbatim %}{{ users_reports.length }}{% endverbatim %}</h4   >
                            </div>
                            <!--
                            <div class="col-sm-4 textright">
                                <input type="text" placeholder="{% blocktrans %}Search student{% endblocktrans %}" class="form-control search-filter">
                            </div>
                            -->
                        </div>
                        <ul class="students header-user-list">
                          <li>
                            <div class="row-eq-height">
                              <div class="col-sm-8">
                                <div class="col-sm-3 fullname">{% trans "Full name" %}</div>
                                <div class="col-sm-1">{% trans "Progress" %}</div>
                                <div class="col-sm-1">{% trans "Date joined"%}</div>
                                <div class="col-sm-1">{% trans "Last access"%}</div>
                                <div class="col-sm-3 email">{% trans "Main E-mail" %}</div>
                                <div class="col-sm-1">{% trans "Occupation" %}</div>
                                <div class="col-sm-2">{% trans "Grade" %}</div>
                              </div>
                              <div class="col-sm-4">
                                <div class="col-sm-4">{% trans "Disciplines" %}</div>
                                <div class="col-sm-2">{% trans "State" %}</div>
                                <div class="col-sm-3">{% trans "City" %}</div>
                                <div class="col-sm-3 textcenter"></div>
                              </div>
                            </div>
                          </li>
                        </ul>
                        <ul class="students" ng-show="users_reports.$resolved">
                            <li ng-repeat="user in users_reports">
                                  <div class="row">
                                    {% verbatim %}
                                    <div class="col-sm-8">
                                      <div class="col-sm-3">{{user.first_name}} {{user.last_name}}</div>
                                      <div class="col-sm-1 hidden-xs">
                                          <div class="progress">
                                              <div class="progress-bar" style="width:{{ user.course_progress }}%;display:none;">{{ user.course_progress }}%</div>
                                              <div class="progress-bar" style="width:80%;">80%</div>
                                          </div>
                                      </div>
                                      <div class="col-sm-1">20/12/2017</div>
                                      <div class="col-sm-1">10/04/2018</div>
                                      <div class="col-sm-3 email">{{ user.email }}</div>
                                      <div class="col-sm-1">Professor(a)</div>
                                      <div class="col-sm-2">1º ano EF, 2º ano EF</div>
                                    </div>
                                    {% endverbatim %}
                                    <div class="col-sm-4">
                                        <div class="col-sm-4">Matemática, Português</div>
                                        <div class="col-sm-2">SP</div>
                                        <div class="col-sm-3">Campinas</div>
                                        <div class="col-md-3 col-sm-3 col-xs-12 textright">
                                            <span class="label label-default pointer" ng-click="show_user_progress_details(user);showLessons=!showLessons">
                                                {% trans 'Show lessons' %}
                                                <i class="fa" ng-class="{'fa fa-caret-down':!showLessons,'fa fa-caret-up':showLessons}"></i>
                                            </span>
                                        </div>
                                    </div>


                                    <div class="lessons col-xs-12" ng-if="showLessons">
                                        <div class="col-lg-12" ng-hide="user.lessons_stats.$resolved">
                                            <span>{% trans 'Loading student report' %}...   <i class="loading fa fa-refresh fa-spin"></i></span>
                                        </div>
                                        <div class="row row-show-lessons">
                                          <div class="col-sm-12 lesson" ng-repeat="lesson in user.lessons_stats.lessons_progress">
                                              {% verbatim %}

                                                  <div class="col-lg-5 col-md-6 col-sm-7 col-xs-10">{{ lesson.name }}</div>
                                                  <div class="col-md-1 col-sm-2 col-xs-2 textright">{{ lesson.progress | number:0 }}%</div>
                                                  <div class="col-md-2 col-sm-3 hidden-xs">
                                                      <div class="progress">
                                                          <div class="progress-bar" style="width:{{ lesson.progress }}%;"></div>
                                                      </div>
                                                  </div>
                                                  <!--<div class="col-lg-5">
                                                      <span>0 perguntas no fórum</span>
                                                      <span>0 respostas no fórum</span>
                                                      <span>0 anotações</span>
                                                  </div>-->

                                              {% endverbatim %}
                                          </div>
                                        </div>
                                    </div>
                                  </div>
                              </li>
                        </ul>
                    </div>

                    <!-- tab de AULAS -->
                    <div class="tab-pane fade in" id="lessons">
                        <div class="row">
                            <div class="col-lg-8">
                                <h3>{% trans 'Average student progress per class' %}</h3>
                                <div class="col-lg-12" ng-hide="course_stats.$resolved">
                                    <p>{% trans 'Loading lessons report' %}...   <i class="loading fa fa-refresh fa-spin"></i></p>
                                </div>
                            </div>
                        </div>
                        <ul class="lessons">
                            <li class="lesson" ng-repeat="lesson in course_stats.lessons_avg_progress">
                                {% verbatim %}
                                <div class="row">
                                    <div class="col-lg-5 col-md-6 col-sm-7 col-xs-10">{{ lesson.name }}</div>
                                    <div class="col-sm-1 col-xs-2 textright">{{ lesson.progress  | number:0  }}%</div>
                                    <div class="col-md-2 col-sm-3 hidden-xs">
                                        <div class="progress">
                                            <div class="progress-bar" style="width:{{ lesson.progress }}%;"></div>
                                        </div>
                                    </div>
                                    <!--<div class="col-lg-5">
                                        <span>0 perguntas no fórum</span>
                                        <span>0 respostas no fórum</span>
                                        <span>0 anotações</span>
                                    </div>-->
                                </div>
                                {% endverbatim %}
                            </li>
                        </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </section>
    <!--Deveria incluir pagination -->
    <pagination total-items="total_users_found"
                items-per-page="50"
                ng-model="current_page"
                ng-change="page_changed()"
                max-size="5"
                boundary-links="true"
                previous-text="{% trans 'Previous' %}"
                next-text="{% trans 'Next' %}"
                first-text="{% trans 'First' %}"
                last-text="{% trans 'Last' %}"
              ng-hide="filtered">
    </pagination>
</div>


{% endblock content %}
